# 功能转测报告 - FP-019 定制撮合

**任务信息**:
- **功能ID**: FP-019
- **功能名称**: 定制撮合 (Custom Order Matching)
- **提交时间**: 2026-01-20
- **开发状态**: ✅ 已完成 (Dev Complete)
- **关联优化**: UX-OPT (体验优化)

---

## 1. 交付范围 (Scope of Delivery)

### 1.1 核心功能 (Core Features)
| 功能模块 | 功能点 | 描述 | 涉及端 |
| :--- | :--- | :--- | :--- |
| **后台管理** | **管理员指派地陪** | 允许管理员将状态为 `waiting_for_guide` 或 `paid` 的定制订单直接指派给指定地陪 | Admin |
| **后台管理** | **地陪选择弹窗** | 在订单列表页提供“指派”操作入口，弹出地陪选择列表（展示头像、昵称、价格） | Admin |
| **状态流转** | **自动接单** | 指派成功后，订单状态自动变更为 `in_progress` (已接单/待服务) | Server |

### 1.2 附带优化 (UX Improvements)
> 在开发本功能过程中顺带修复的高优体验问题：
| 优化点 | 描述 |
| :--- | :--- |
| **空状态优化** | 订单列表和地陪列表无数据时，展示统一的 EmptyState 组件及引导按钮 |
| **地陪认证流程** | 修复了保存资料后个人中心状态未同步的问题；优化了编辑页的加载骨架屏 |
| **个人中心导航** | 修复了"管理地陪资料"按钮的 404 路由错误；移除了冗余的菜单入口 |

### 1.3 缺陷修复 (Bug Fixes)
- 修复了 `Profile.tsx` 中地陪认证按钮状态判断逻辑，确保已认证用户显示“管理资料”。
- 修复了 `GuideEdit.tsx` 保存成功后未刷新 `AuthContext` 导致状态滞后的问题。

---

## 2. 测试建议 (Test Strategy)

### 2.1 重点测试场景
1. **定制订单指派流程 (FP-019)**:
   - **前置**: 创建一个 `custom` 类型订单，状态为 `waiting_for_guide`。
   - **操作**: 登录后台 -> 订单管理 -> 点击“指派” -> 选择地陪 -> 确认。
   - **验证**: 
     - 列表状态变为“进行中” (in_progress)。
     - 数据库 `orders` 表的 `guide_id` 正确更新。
     - 再次点击指派按钮不可见（状态已变更）。

2. **地陪认证闭环 (UX)**:
   - **前置**: 使用普通用户账号登录。
   - **操作**: 个人中心 -> 认证为地陪 -> 填写资料并保存。
   - **验证**: 
     - 保存后自动跳转回个人中心。
     - 个人中心按钮变为“管理地陪资料”。
     - 再次点击可进入编辑页且回显数据。

3. **路由与空状态**:
   - 验证 `/guides/profile` 路由可正常访问。
   - 清空筛选条件下的地陪列表，验证空状态显示。

### 2.2 接口变更
- **新增**: `POST /api/v1/admin/orders/:id/assign` (Body: `{ "guideId": 123 }`)

---

## 3. 部署说明 (Deployment)

- **数据库**: 无 Schema 变更。
- **配置**: 无新增环境变量。
- **构建**: 需执行 `npm run build:client` 更新前端资源。

---

## 4. 已知问题 (Known Issues)
- 目前指派地陪列表中仅加载前 100 位地陪，暂不支持搜索（MVP 阶段妥协）。
- 指派成功后暂无短信/系统通知（待后续 FP-020 通知模块实现）。
