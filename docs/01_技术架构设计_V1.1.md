# 陪你App - 技术架构设计文档 V1.1 (最终版)

**版本**: 1.1 (全栈一体化版)  
**更新日期**: 2026年1月18日  
**作者**: Manus AI (与用户协同)  
**用途**: 本文档是“陪你App”MVP阶段的最终技术架构方案，用于指导后续的数据库设计、API开发和团队协作。

---

## 1. 系统架构 (MVP阶段)

### 1.1. 架构图

本架构采用全栈一体化模式，前后端代码在同一个Node.js应用中，支持Web端，并为未来扩展原生App预留了API能力。

```mermaid
graph TD
    subgraph "客户端"
        A[用户浏览器/微信内置浏览器] -->|HTTPS| B{Node.js 全栈应用<br>(Express + React)}
        G[未来移动App (iOS/Android)]-.->|HTTPS| B
    end

    subgraph "单台云服务器 (Single VPS)"
        B -->|/api/*| C[Express 后端服务]
        B -->|/* 静态文件| D[React 前端应用]
        C <--> E[MySQL 8.0+ 数据库]
        C -->|微信支付API| F[微信支付网关]
    end

    style E fill:#f0db4f,stroke:#333,stroke-width:2px
```

### 1.2. 部署模型

- **部署方式**: 单机部署。所有服务（Node.js全栈应用, MySQL数据库）均部署在同一台云服务器上。
- **核心原则**: 全栈一体化。前后端代码在同一个Node.js应用中，简化开发、部署和维护。
- **项目结构**: 采用Monorepo模式组织代码：
  ```
  gepei-app/
  ├── server/          # Express后端代码
  ├── client/          # React前端代码
  ├── shared/          # 共享的类型定义和常量
  └── package.json     # 统一的依赖管理
  ```
- **API模式**: 后端提供标准的RESTful API，可同时服务于Web端和未来的原生App端。

---

## 2. 技术栈选型 (最终版)

| 模块 | 技术选型 | 核心理由 |
| :--- | :--- | :--- |
| **后端框架** | **Node.js + Express.js + TypeScript** | 全栈技术统一，开发效率高，NPM生态成熟。 |
| **前端框架** | **React + TypeScript + Tailwind CSS** | 业界主流，类型安全，UI开发速度快。 |
| **数据库** | **MySQL (版本 8.0+)** | 社区庞大，人才储备丰富，完全满足业务规模需求，运维简便。 |
| **认证机制** | **JWT (JSON Web Token)** | 简单、无状态、易于横向扩展。 |

---

## 3. 架构维度与分阶段规划

### 3.1. 安全 (Security)

| 安全措施 | MVP阶段 (Must-Have) | 未来迭代 (Nice-to-Have) |
| :--- | :--- | :--- |
| **传输安全** | ✅ 全站HTTPS | - |
| **密码存储** | ✅ 密码加盐哈希 (`bcrypt`) | - |
| **API认证** | ✅ JWT Token认证 | Refresh Token机制 |
| **输入验证** | ✅ 所有API输入进行严格验证 | - |
| **防SQL注入** | ✅ 使用ORM (如Prisma或TypeORM) | - |
| **速率限制** | ✅ 关键API进行速率限制 | 更精细化的限制策略 |
| **Web应用防火墙** | ❌ | ✅ 引入云服务商的WAF |
| **多因素认证(MFA)** | ❌ | ✅ 为地陪和管理员提供 |

### 3.2. 可伸缩性 (Scalability)

| 伸缩性策略 | MVP阶段 | 未来迭代 |
| :--- | :--- | :--- |
| **部署模型** | ✅ 单机部署 | ✅ 数据库与应用分离 -> 应用服务集群 |
| **无状态服务** | ✅ 后端服务设计为无状态 | - |
| **图片/静态资源** | ✅ 存储在本地文件系统 | ✅ 迁移到对象存储(OSS) + CDN |

### 3.3. 可观测性 (Observability)

| 观测性措施 | MVP阶段 | 未来迭代 |
| :--- | :--- | :--- |
| **日志** | ✅ 基础文件日志 (`pino`或`winston`) | ✅ 集中式日志系统 (如ELK) |
| **监控与告警** | ❌ | ✅ 引入监控系统 (如Prometheus) |
| **链路追踪** | ❌ | ✅ 引入分布式链路追踪 (如Jaeger) |

---

## 4. 关键技术决策

- **支付流程**: 采用微信JSAPI支付，后端通过回调接口处理业务逻辑，更新订单状态。
- **订单超时**: 使用`node-cron`等库实现定时任务，每分钟检查并自动取消超时未支付的订单。
- **图片存储**: MVP阶段直接存储在服务器本地文件系统，通过Express静态文件服务提供访问。文件名自动生成（时间戳+随机字符串），防止冲突和枚举。未来可平滑迁移至对象存储。
- **管理员认证**: 采用简化方案，管理员账户由系统初始化时创建，使用JWT Token认证。MVP阶段所有管理员拥有相同权限。
- **全栈一体化**: 采用Monorepo模式，前后端代码在同一个Node.js应用中。开发时使用`npm run dev`启动单一服务，生产环境编译后通过`npm start`启动。

---

## 5. 后续步骤

基于此最终架构方案，下一步将进行：

1.  **数据库设计** (详细的表结构定义)
2.  **API文档编写** (供前后端同事使用的接口规范)
3.  **第一周开发任务清单**
