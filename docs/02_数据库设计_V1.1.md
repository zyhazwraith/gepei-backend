# 限你App - 数据库设计 V1.1

**版本**: 1.1  
**更新日期**: 2026年1月18日  
**作者**: Manus AI (与用户协同)  
**用途**: 本文档定义MVP阶段所有数据库表结构，直接对应产品功能规划。

---

## 1. 设计原则

- **关系型设计**: 充分利用MySQL关系型特性，避免数据冗余。
- **软删除**: 核心表包含`deleted_at`字段，支持数据恢复。
- **审计字段**: 所有表包含`created_at`和`updated_at`，便于追踪变化。
- **业务完整性**: 每个表直接对应产品功能，确保无遗漏。

---

## 2. 核心表结构

### 2.1. users (用户表)

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号',
  password_hash VARCHAR(255) NOT NULL COMMENT 'bcrypt加密密码',
  nickname VARCHAR(100) COMMENT '昵称',
  avatar_url VARCHAR(500) COMMENT '头像URL',
  role VARCHAR(50) DEFAULT 'user' COMMENT '角色: user/admin',
  
  -- 地陪认证
  is_guide BOOLEAN DEFAULT FALSE,
  guide_id_number VARCHAR(50) COMMENT '身份证号',
  guide_id_verified_at TIMESTAMP NULL,
  
  -- 余额
  balance DECIMAL(10, 2) DEFAULT 0,
  
  -- 审计
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  
  KEY idx_phone (phone),
  KEY idx_role (role),
  KEY idx_is_guide (is_guide)
);
```

### 2.2. guides (地陪资料表)

```sql
CREATE TABLE guides (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL UNIQUE,
  name VARCHAR(100) NOT NULL,
  city VARCHAR(50) NOT NULL,
  intro TEXT,
  hourly_price DECIMAL(10, 2),
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  KEY idx_city (city)
);
```

### 2.3. guide_photos (地陪照片表)

```sql
CREATE TABLE guide_photos (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  guide_id BIGINT NOT NULL,
  photo_url VARCHAR(500) NOT NULL,
  sort_order INT DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  
  FOREIGN KEY (guide_id) REFERENCES guides(id),
  KEY idx_guide_id (guide_id)
);
```

### 2.4. guide_tags (地陪标签表)

```sql
CREATE TABLE guide_tags (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  guide_id BIGINT NOT NULL,
  tag VARCHAR(50) NOT NULL,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (guide_id) REFERENCES guides(id),
  UNIQUE KEY uk_guide_tag (guide_id, tag)
);
```

### 2.5. orders (订单表)

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_number VARCHAR(50) UNIQUE NOT NULL,
  type ENUM('custom', 'normal') DEFAULT 'custom' COMMENT '订单类型: custom(定制)/normal(普通)',
  
  customer_id BIGINT NOT NULL,
  guide_id BIGINT,
  
  status ENUM('待支付', '已支付', '等待报名', '已报名', '服务中', '已完成', '已取消') DEFAULT '待支付',
  
  service_date DATE NOT NULL,
  service_location VARCHAR(255) NOT NULL,
  budget DECIMAL(10, 2) NOT NULL,
  service_content TEXT COMMENT '服务内容描述',
  
  deposit_amount DECIMAL(10, 2) DEFAULT 150,
  total_amount DECIMAL(10, 2),
  paid_at TIMESTAMP NULL,
  completed_at TIMESTAMP NULL COMMENT '订单完成时间',
  cancelled_at TIMESTAMP NULL COMMENT '订单取消时间',
  
  wechat_prepay_id VARCHAR(100),
  wechat_transaction_id VARCHAR(100),
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  
  FOREIGN KEY (customer_id) REFERENCES users(id),
  FOREIGN KEY (guide_id) REFERENCES guides(id),
  KEY idx_type (type),
  KEY idx_customer_id (customer_id),
  KEY idx_guide_id (guide_id),
  KEY idx_status (status),
  KEY idx_created_at (created_at)
);````

### 2.6. custom_order_details (定制订单私有属性表)

```sql
CREATE TABLE custom_order_details (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL UNIQUE,
  
  special_requirements TEXT COMMENT '特殊要求',
  waiting_timeout_at TIMESTAMP NULL COMMENT '等待报名超时时间',
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

### 2.7. custom_order_candidates (定制订单候选地陪表)

```sql
CREATE TABLE custom_order_candidates (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  guide_id BIGINT NOT NULL,
  sort_order INT DEFAULT 0,
  status ENUM('pending', 'selected', 'rejected') DEFAULT 'pending' COMMENT '候选地陪状态',
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (order_id) REFERENCES orders(id),
  FOREIGN KEY (guide_id) REFERENCES guides(id),
  UNIQUE KEY uk_order_guide (order_id, guide_id)
);
```

### 2.8. messages (消息表 - 预留)

```sql
CREATE TABLE messages (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  sender_id BIGINT NOT NULL,
  receiver_id BIGINT NOT NULL,
  content TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  
  FOREIGN KEY (sender_id) REFERENCES users(id),
  FOREIGN KEY (receiver_id) REFERENCES users(id),
  KEY idx_receiver_id (receiver_id)
);
```

### 2.9. admin_logs (管理员操作日志表)

```sql
CREATE TABLE admin_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  admin_id BIGINT NOT NULL,
  action VARCHAR(100) NOT NULL,
  target_type VARCHAR(50) NOT NULL,
  target_id BIGINT NOT NULL,
  details JSON,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (admin_id) REFERENCES users(id),
  KEY idx_admin_id (admin_id),
  KEY idx_action (action)
);
```

---

## 3. 初始化脚本

### 创建默认管理员账户

```sql
-- 密码: admin123 (bcrypt加密后的哈希值)
INSERT INTO users (phone, password_hash, nickname, role) 
VALUES ('13800000000', '$2b$10$...', '管理员', 'admin');
```

---

## 4. 关键设计说明

- **用户表**: 管理员和普通用户共用`users`表，通过`role`字段区分。安全性通过应用层的权限验证实现。
- **订单表**: 所有订单类型共用`orders`表，通过`type`字段区分。定制订单的私有属性在`custom_order_details`表中。
- **订单状态时间戳**: `completed_at`记录订单完成时间，`cancelled_at`记录订单取消时间，便于统计和审计。
- **候选地陪状态**: `custom_order_candidates`表中的`status`字段记录地陪是否被选中。
- **等待报名超时**: `custom_order_details`表中的`waiting_timeout_at`记录定制订单的等待报名超时时间。
- **评价功能**: 不在MVP范围内，故无`reviews`表。
- **消息功能**: MVP仅UI占位，表结构预留，不实现业务逻辑。
- **订单超时**: 通过后端定时任务检查`created_at`字段实现。
