# 产品需求规格说明书 V2_FINAL

**版本**: V2.0 (FINAL)
**状态**: Approved (开发基准)
**日期**: 2026-01-27
**来源**: 融合 `USER_FLOW_V2.md` (V1) 与 `08_需求变动_V2.0.md` (V2 Rev 4)

---

## 1. 引言与全局规则 (Global Rules)

本版本旨在重构核心交易流程，确立“统一平台支付”原则，并完善后台管理与资金结算体系。文档完整包含了 V1 的交互细节与 V2 的业务逻辑，是后续开发的唯一依据。

### 1.1 核心业务原则
1.  **统一支付**: 所有订单（含普通单、定制单、加时单）均需在平台内完成线上支付，**禁止线下转账**。
2.  **支付超时**: 所有“待支付”状态订单，创建后 **60分钟** 内未支付自动关闭。
3.  **退款政策 (风控)**:
    *   **冷静期 (1小时内)**: 下单后1小时内申请取消，**全额退款**。
    *   **违约期 (超过1小时)**: 扣除 **¥150** 违约金，退还剩余金额。
    *   **执行**: 用户联系客服 -> 客服后台执行（需记录审计日志）。

---

## 2. 用户角色定义 (User Roles)

### 1. 普通用户（客户）
- 寻求本地导游服务的游客。

### 2. 地陪用户
- 提供导游服务的本地人。

### 3. 管理员体系 (Admin RBAC)
- **超级管理员**: 系统最高权限管理者。
- **运营客服**: 负责日常业务操作与用户沟通。

---

## 3. 核心用户流程 (Core User Workflows)

### 流程0：浏览与登录触发 (Browsing) `[V1 保留]`

> **核心逻辑**: 仅描述 App 的准入与路由拦截机制，具体登录注册操作见 Flow 1。

```
开始
  ↓
【无需登录浏览】
(首页 / 地陪列表 / 地陪详情)
  ↓
用户触发【关键交互】
(点击"预订" / "发起定制" / "个人中心")
  ↓
系统判定: 是否已登录?
  │
  ├── [已登录] ──→ 进入对应功能页面 (流程结束)
  │
  └── [未登录]
        ↓
      跳转至【登录页面】
        ↓
      [执行登录/注册流程 (见 Flow 1)]
        ↓
      登录成功?
        │
        ├── [是] ──→ 自动回跳至触发前的功能页面
        │
        └── [否/返回] ──→ 停留在浏览页
```

---

### 流程1：用户注册与认证 (Registration) `[V1 保留]`

```
开始
  ↓
输入手机号、密码
  ↓
注册成功（作为普通用户）
  ↓
进入首页
  ↓
（可选）在个人中心点击"认证为地陪"
  ↓
进入地陪资料编辑界面
  ↓
填入身份证信息进行校验
  ↓
成为地陪用户
  ↓
结束
```

**关键点**：
- 客户注册时**不需要实名认证**。
- 地陪认证是**可选的**，用户可以先作为客户使用，后续再认证。
- 认证和资料编辑在**同一个界面**完成。
- **交互细节**: 登录/注册页面必须包含**返回按钮** (或关闭图标)，允许用户放弃登录并返回之前的浏览页面。

---

### 流程2：地陪展示与浏览 (Guide Display) `[V1 保留]`

```
开始
  ↓
进入首页
  ↓
查看地陪列表（卡片式）
  ↓
点击地陪卡片
  ↓
进入地陪详情页
  ↓
查看地陪信息：
  - 头像
  - 照片轮播（最多5张，默认显示第一张，可滑动）
  - 名字、城市、小时价格
  - 个人介绍
  - 技能标签
  - 评分和评价
  ↓
（可选）返回列表继续浏览
  ↓
结束
```

**关键点**：
- 地陪照片支持轮播，用户可以滑动查看。
- 显示地陪的完整信息和评价。
- 支持搜索和筛选功能。

---

### 流程3：私人定制单发起 (Custom Order) `[V2 重构]`

> **变更说明**: 废弃原有的“填表->付定金->选人”流程，改为“线下咨询->后台建单->线上支付”。

```
开始
  ↓
进入首页 -> 点击"发起定制单"
  ↓
弹出/跳转【定制咨询页面】
  ↓
显示【客服二维码】与咨询指引
  ↓
用户扫描二维码，添加企业微信客服
  ↓
【线下沟通】
用户与客服沟通需求 (日期/地点/预算/特殊要求)
  ↓
【后台操作】
客服在后台"创建定制订单"
(录入：客户手机号、需求详情、协商总价)
  ↓
【App端同步】
用户收到通知 / 刷新"我的订单"列表
  ↓
看到一笔状态为【待支付】的定制订单
  ↓
点击进入详情 -> 确认信息无误
  ↓
点击"立即支付" -> 完成全额支付
  ↓
订单进入【待服务】
  ↓
(后续流程同普通订单，客服协助指派地陪)
  ↓
结束
```

**关键点**：
- 定制单改为**先咨询后建单**。
- 支付**只支持微信**（或其他线上方式），全额支付。
- 订单创建权下放给**运营客服**。

---

### 流程4：普通订单流程 (Standard Order) `[V2 修改]`

```
开始
  ↓
用户浏览地陪详情 -> 点击"预订"
  ↓
选择日期与时长 -> 确认金额
  ↓
进入支付页面 (全额支付)
  ↓
支付成功 -> 订单状态变更为【待服务】
  ↓
界面显著展示【客服二维码】
(文案：已接单！请扫码添加客服沟通具体行程)
  ↓
用户扫码联系客服
  ↓
服务开始 (地陪打卡) -> 服务结束 (地陪打卡)
  ↓
结束
```

---

### 流程5：加时服务流程 (Overtime Service) `[V2 新增]`

```
开始
  ↓
订单处于【服务中】状态
  ↓
用户/地陪协商一致需加时
  ↓
用户进入订单详情页 -> 点击"申请加时"
  ↓
选择加时时长 -> 系统计算费用
  ↓
支付加时费用
  ↓
生成【加时子订单】(关联主订单)
  ↓
加时成功 (服务结束时间顺延)
  ↓
结束
```

---

### 流程6：订单管理 (客户端) `[V2 修改]`

```
开始
  ↓
进入个人中心 -> 点击"订单"
  ↓
显示"我下的单"标签页
  ↓
显示订单列表：
  - 订单号、地陪名字、状态、总支出(含加时)
  ↓
支持筛选 (状态/日期/金额)
  ↓
点击订单卡片 -> 进入订单详情页
  ↓
显示订单详情：
  【订单状态卡片】
  - 当前状态：待支付(倒计时)/待服务(显示客服码)/服务中/已完成等

  【订单基本信息】
  - 订单编号、类型(定制/普通)、下单时间

  【地陪信息】
  - 头像、名字、评分

  【服务详情】
  - 地点、内容、特殊要求

  【加时记录】(V2 新增板块)
  - 列表展示每一笔加时记录 (时长/费用)

  【费用明细】
  - 总计：¥XXX

  【操作按钮】
  - 待支付：立即支付
  - 服务中：申请加时
  - 已完成：评价/再次预订
  ↓
结束
```

**关键点**：
- **加时记录**作为子板块展示在详情页中。
- 费用显示为聚合后的总金额。

---

### 流程7：订单管理 (地陪端) `[V2 修改]`

```
开始
  ↓
进入个人中心 -> 点击"订单"
  ↓
显示"我接的单"标签页
  ↓
显示订单列表：
  - 订单号、客户名字、状态、总收益
  ↓
点击订单卡片 -> 进入订单详情页
  ↓
显示内容同客户端，但金额显示为【预计收益】
  ↓
操作按钮：
  - 待服务：查看客户信息
  - 服务中：上传照片打卡(开始/结束)
  ↓
结束
```

---

### 流程8：地陪资料编辑与 LBS `[V2 修改]`

```
开始
  ↓
进入地陪资料编辑界面
  ↓
【部分1】头像编辑 (上传/更换)
  ↓
【部分2】照片库编辑 (最多5张，支持拖拽)
  ↓
【部分3】基本信息编辑
  - 名字、小时价格 (***期望价格***) `[V2 补充]`
  - 个人介绍
  - **LBS 位置录入** (V2 新增): 打开地图SDK选点 -> 记录经纬度/城市/地址
  ↓
【部分4】技能标签 (添加/删除)
  ↓
【部分5】身份确认 (仅首次)
  - 输入真实姓名
  - 勾选 "我已年满18周岁" (必填)
  ↓
保存 -> 提交审核
  ↓
结束
```

**关键点**：
- **LBS 选点**是新增的必填步骤。
- **期望价格**：地陪填写的价格为“期望价格”，最终展示价格由管理员审核决定。

---

### 流程9：余额与提现 `[V2 修改]`

```
开始
  ↓
进入个人中心 -> 点击"余额和提现"
  ↓
显示余额信息 (当前余额/累计收益/交易历史)
  ↓
点击"提现"按钮
  ↓
输入金额 -> 确认申请
  ↓
生成提现单 (状态: 审核中)
  ↓
【后台流程】
管理员人工核对 -> 线下转账 -> 后台点击"通过"
  ↓
App端提现单状态变更为"已完成"
  ↓
结束
```

---

## 4. 后台管理流程 (Admin Workflows)

### 流程10：人员管理与审核 `[V2 修改]`

**1. 列表与筛选**:
- 显示用户/地陪列表。
- 支持按 城市、手机号、类型 筛选。

**2. 地陪审核详情页** `[V2 核心]`:
- **全量资料展示**:
    - 个人基本信息 (头像/名字/手机号)。
    - **LBS 信息**: 城市、详细地址、经纬度地图预览。
    - **相册**: 轮播展示所有上传照片。
    - **简介**: 个人介绍文本。
- **操作区**:
    - **定价设置**: 输入 **“真实展示价格”** (覆盖地陪的期望价格)。
    - **审核决议**: [通过] / [驳回]。
- **封禁管理**:
    - [封禁账号]: 需填写封禁原因。
    - [解禁账号]: 恢复正常状态。

### 流程11：订单管理与定制单创建 `[V2 修改]`
- **列表展示**: 所有订单状态与详情。
- **定制单创建 (V2)**: 客服录入需求 -> 生成待支付订单。
- **资金操作 (仅超管)**: 处理提现申请、执行退款。

### 流程12：订单取消与退款 (Refund Workflow)
1.  **触发**: 用户线下联系客服申请退款。
2.  **判定**: 客服根据订单创建时间判定是否处于“冷静期”。
    *   **冷静期 (1h内)**: 应全额退款。
    *   **违约期 (>1h)**: 应扣除 ¥150 违约金。
3.  **执行**: 客服在后台订单详情页点击“取消订单”。
4.  **输入**: 系统弹出对话框，客服**手动输入**最终退款金额。
5.  **处理**: 系统调用微信退款接口，并将订单状态置为 `REFUNDED`，同时记录操作日志（含操作人、退款金额）。

---

## 5. 功能模块规格 (System Specs) `[V2 新增]`

### 5.1 订单中心 (Order Center)
*   **状态机 (State Machine)**:
    1.  **待支付 (WAITING_PAYMENT)**: 初始状态。**60分钟**未支付自动转为`CANCELLED`。
    2.  **待服务 (WAITING_SERVICE)**: 支付成功。
    3.  **服务中 (IN_SERVICE)**: 地陪上传“服务开始照片”后流转至此。允许发起加时。
    4.  **服务结束 (SERVICE_ENDED)**: 地陪上传“服务结束照片”后流转至此。
    5.  **已完成 (COMPLETED)**: 结束满 24h 自动结算。
    6.  **已取消 (CANCELLED)**: 超时未付或客服手动取消（未支付状态）。
    7.  **已退款 (REFUNDED)**: 已支付订单被客服执行退款。
*   **加时计算规则** `[V2 补充]`:
    *   **起始时间**: 若当前订单未结束，按实际结束时间顺延；**若当前订单已超期，按“当前系统时间”起算**。
    *   **费率**: 按地陪当前“真实展示价格”计算。
*   **数据结构**:
    *   支持 **1对N** 结构（Order 1 : N OvertimeRecords）。
    *   费用计算：`Total = BaseOrderPrice + Sum(OvertimePrices)`。

### 5.2 资金结算 (Finance)
*   **抽成规则**: `地陪收入 = 订单总额 * (1 - 25%)`。
*   **钱包体系**:
    *   **收支明细**: 必须关联订单ID，点击可跳转至订单详情。
    *   **提现**: 必须包含 `Admin Audit` 环节，不支持自动打款。

### 5.3 后台管理 (Admin System)
*   **权限矩阵**:
    | 功能模块 | 功能点 | 超级管理员 | 运营客服 |
    | :--- | :--- | :---: | :---: |
    | **地陪管理** | 地陪审核 (含定价) | ✅ | ❌ |
    | | 地陪列表查看 | ✅ | ✅ |
    | **订单管理** | 定制订单创建 | ✅ | ✅ |
    | | 订单列表/详情查看 | ✅ | ✅ |
    | | **订单取消/退款** | ✅ | ❌ |
    | **资金财务** | **提现处理** | ✅ | ❌ |
    | **用户管理** | 用户/地陪封禁 | ✅ | ❌ |
    | **系统配置** | 客服二维码配置 | ✅ | ✅ |

#### 5.3.1 系统配置 `[V2 补充]`
*   **客服二维码**: 管理员可在后台上传/更新客服二维码图片，前端动态拉取展示。

#### 5.3.2 统计报表 `[V2 补充]`
*   **统计基准**: 订单结算时间。
*   **报表维度**:
    *   **客服业绩**: 统计客服创建且已结算的定制订单数量（日/月/年/总）。
    *   **平台收支**: 统计总收入、总提现金额（日/月/年/总）。

#### 5.3.3 审计日志 (Audit Logs) `[V2 补充]`
*   **定位**: 关键业务操作的全程留痕。
*   **记录场景**:
    1.  **地陪审核**: 记录审核人、定价操作、时间。
    2.  **资金提现**: 记录打款确认人、金额。
    3.  **用户管理**: 记录封禁/解禁操作人及原因。
    4.  **退款操作**: 记录退款执行人、退款金额。

### 5.4 个人中心与导航结构 (Personal Center Specs) `[V1 保留]`

**1. 页面结构定义**:
*   **用户信息区**: 必须展示头像、昵称、脱敏手机号。
*   **功能菜单列表**:
    *   `我的订单` -> 关联 Order Center (Flow 6/7)
    *   `地陪认证` -> 关联 Guide Profile (Flow 8)
    *   `余额提现` -> 关联 Finance System (Flow 9)

**2. 导航逻辑**:
*   作为 App 的一级 Tab (底部导航栏第4项)。
*   是所有个人业务流程的**统一入口**。

---

## 6. 交互设计与非功能需求 (UI/UX & NFR) `[V1 保留]`

### 6.1 页面导航
**底部导航栏**（4个标签）：
1.  **首页** - 地陪展示、发起定制单
2.  **地陪** - 搜索和筛选地陪
3.  **高端定制** - 私人定制功能
4.  **我的** - 用户信息、认证、余额、订单

### 6.2 常见交互
*   **表单验证**: 必填字段标记为红色 *；提交前验证所有必填字段。
*   **支付流程**: 显示金额 -> 调起微信支付 -> 成功后返回。
*   **加载状态**: 列表加载显示骨架屏 (Skeleton)；按钮操作显示 Loading 动画。
*   **错误处理**: 网络或接口错误时显示 Toast 提示，提供重试选项。

### 6.3 动画和过渡
*   **页面过渡**: 页面切换时有淡入淡出效果。
*   **按钮反馈**: 按钮按下时有按压效果 (Scale down)。
*   **列表交互**: 列表项支持下拉刷新和上拉加载更多。

### 6.4 无障碍设计 (Accessibility)
*   **键盘导航**: 支持 Tab 键导航所有交互元素。
*   **屏幕阅读器**: 图片需包含 alt 文本；表单标签关联输入框。
*   **色彩对比**: 文本和背景对比度符合 WCAG AA 标准。
*   **字体**: 最小字体 14px，支持系统字体大小缩放。
