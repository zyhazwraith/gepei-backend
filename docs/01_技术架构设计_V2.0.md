# 陪你App - 技术架构设计文档 V2.0

**版本**: 2.0
**更新日期**: 2026年1月28日
**用途**: 本文档基于 V2.0 产品需求，定义系统最新的技术架构方案。

---

## 1. 系统架构

### 1.1. 架构概览

本架构保持全栈一体化模式 (Monorepo)，后端服务采用逻辑分层设计，显式引入**定时任务调度 (Scheduler)** 组件以支持自动化业务流程。

- **后端**: Node.js + Express + TypeScript
- **前端**: React + TypeScript + Tailwind CSS (Vite 构建)
- **数据库**: MySQL 8.0+ (使用 Drizzle ORM)
- **部署**: 单机 VPS 部署

```mermaid
graph TD
    subgraph "客户端"
        A[用户浏览器] -->|HTTPS| B{Nginx / Node.js}
    end

    subgraph "服务器 (Single VPS)"
        B -->|/api/*| C[Express HTTP Server]
        B -->|/* 静态资源| D[React Client Build]
        C <--> E[MySQL 数据库]
        C -->|本地存储| F[文件上传目录 (uploads/)]
        
        G[Scheduler Service] -.->|每分钟/每小时| C
        G -.->|更新状态| E
    end
```

### 1.2. 项目结构 (Monorepo)

```
gepei-app/
├── server/          # Express 后端代码
│   ├── controllers/ # 业务逻辑 (含支付、订单核心逻辑)
│   ├── routes/      # 路由定义
│   ├── models/      # Drizzle ORM 模型
│   ├── middleware/  # 中间件
│   ├── scheduler/   # 定时任务 (Cron Jobs)
│   └── ...
├── client/          # React 前端代码
├── shared/          # 前后端共享类型
├── docs/            # 项目文档
└── package.json     # 统一依赖管理
```

---

## 2. 技术栈选型

| 模块 | 技术选型 | 说明 |
| :--- | :--- | :--- |
| **后端框架** | **Express + TypeScript** | 核心 Web 服务，包含 Scheduler 模块实现。 |
| **ORM** | **Drizzle ORM** | 类型安全的数据访问层，高性能且支持 MySQL。 |
| **数据库** | **MySQL 8.0+** | 核心数据存储。LBS 功能使用 `DECIMAL` 存储。 |
| **支付服务** | **WeChat Pay SDK** | 集成微信支付能力，处理统一下单、退款与回调。 |
| **地图服务** | **Tencent Map SDK** | 提供 LBS 选点、逆地址解析与距离计算能力。 |
| **认证** | **JWT (jsonwebtoken)** | 无状态认证，Token 包含用户 ID 和角色。 |

---

## 3. 关键功能实现方案

### 3.1. 定时任务调度 (Scheduler)
为了满足 V2.0 的自动化业务规则，引入 Scheduler 逻辑组件（实现上可使用 `node-cron` 等轻量库）：
- **订单超时关闭**: 每分钟扫描状态为 `WAITING_PAYMENT` 且创建超过 60 分钟的订单 -> 更新为 `CANCELLED`。
- **自动结算**: 每小时扫描状态为 `SERVICE_ENDED` 且结束超过 24 小时的订单 -> 更新为 `COMPLETED` 并触发资金结算。

### 3.2. 支付与退款 (Payment & Refund)
- **统一支付**: 所有交易（含普通单、定制单、加时费）均通过微信支付 API 完成，禁止线下交易。
- **退款机制**: 
    - **人工介入模式**: 系统不设自动退款规则引擎。
    - **流程**: 管理员通过后台接口提交“退款金额”，后端服务验证金额合法性（<= 订单实付额）后，调用微信支付 API 执行原路退回，并更新状态为 `REFUNDED`。

### 3.3. 订单流程与状态机
- **状态流转**: 
    - 正常流: `WAITING_PAYMENT` -> `WAITING_SERVICE` -> `IN_SERVICE` -> `SERVICE_ENDED` -> `COMPLETED`。
    - 异常流:
        - `CANCELLED`: 超时未付或待支付状态下取消。
        - `REFUNDED`: 已支付订单被客服执行退款。
- **加时服务**: 采用 **主订单 + 子订单 (1:N)** 的数据聚合结构，主订单记录总金额，子订单记录单次加时明细。

### 3.4. LBS (基于位置的服务)
- **存储**: 使用 `DECIMAL(10, 6)` 存储经纬度（精度约 0.1 米）。
- **计算**: 后端负责基于 Haversine 公式的距离计算。

---

## 4. 未来规划 (Roadmap)

- **消息推送**: 实现 WebSocket 或 SSE 以支持实时通知 (如支付成功通知、接单通知)。
- **对象存储**: 将文件存储迁移至 AWS S3 或阿里云 OSS。
- **CI/CD**: 建立自动化部署流程。
