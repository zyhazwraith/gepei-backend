# 需求变动规格说明书 V2.0 (Revision 4)

**版本**: V2.0 (Rev 4)  
**状态**: Approved (待实施)  
**日期**: 2026-01-27

## 1. 引言 (Introduction)
本次变动旨在重构“定制订单”流程，统一全平台支付逻辑，并完善资金结算、钱包体系及后台管理功能。

---

## 2. 核心业务流程 (Core Workflows) - *The Context*

### 2.1 全局业务规则
*   **统一支付**: 所有订单（含普通单、定制单、加时单）均需在平台内完成线上支付，禁止线下转账。
*   **支付超时**: 所有“待支付”状态订单，创建后 **60分钟** 内未支付自动关闭。
*   **退款政策 (客服执行标准 SOP)**:
    *   **冷静期 (1小时内)**: 下单后1小时内申请取消，**全额退款**。
    *   **违约期 (超过1小时)**: 扣除 **¥150** 违约金，退还剩余金额。
    *   **执行**: 由用户联系客服，客服在后台人工执行退款。

### 2.2 普通订单流程 (Standard Order)
1.  **下单**: 用户填写下单需求信息。
2.  **支付**: 用户在平台内直接完成在线支付。
3.  **待服务**:
    *   支付成功后，订单进入 **“待服务”** 状态。
    *   **关键交互**: 界面显著展示 **客服二维码**，提示文案：**“已接单！请扫描二维码添加客服微信，沟通具体行程与地陪安排。”**

### 2.3 定制订单流程 (Custom Order)
1.  **沟通**: 已登录用户在定制页面扫描客服微信二维码，添加客服好友。
    *   *前置条件*: 未登录用户访问页面时，系统强制引导注册/登录。
2.  **创单**: 客服在后台录入订单信息，生成 **“待支付”** 订单。
3.  **支付**: 用户在前端订单列表查看到该订单，并在线完成支付。
4.  **待服务**: 支付成功后，订单自动流转至 **“待服务”** 状态。

### 2.4 加时与异常流程
*   **加时服务**:
    *   仅限 **“服务中”** 状态发起。
    *   用户在订单详情页发起加时请求并支付。
    *   若当前时间已超期，加时起始时间按 **当前时间** 计算。
*   **退款操作流**:
    *   用户联系客服 -> 客服判定金额 -> 客服后台点击“取消并退款” -> 手动输入退款金额 -> 系统执行。
    *   退款操作需记录在审计日志中。
---

## 3. 功能模块规格 (System Specs) - *The Specs*

### 3.1 订单中心 (Order Center)
*   **状态机 (State Machine)**:
    1.  **待支付**: 初始状态 (60min 超时)。
    2.  **待服务**: 支付成功。
    3.  **服务中**: 地陪上传 **服务开始照片** 后流转至此。
    4.  **服务结束**: 地陪上传 **服务结束照片** 后流转至此。
    5.  **已完成**: 结束满 24h 自动结算。
*   **加时单规格**:
    *   **数据结构**: 需支持 **1对N** 结构（一个主订单对应多个加时记录），加时费用计入总交易额。
    *   **订单 UI 展示规范**:
        *   **订单列表页**: 展示 **聚合数据**（主订单费用 + 所有加时费用 = 总花费；主订单时长 + 所有加时时长 = 总时长）。
        *   **订单详情页**: 在主订单信息下方，新增 **“加时记录”** 子板块，列表展示每一笔加时单的详情。

### 3.2 资金结算 (Finance)
*   **抽成规则**: `地陪收入 = 订单总额 * (1 - 25%)`。
*   **钱包体系**:
    *   **余额**: 实时更新。
    *   **收支明细**: 
        *   **粒度**: **订单粒度** (主单+加时汇总为一条收入)。
        *   **交互**: 点击某条收支记录，**必须可跳转** 至关联的 **订单详情页**。
*   **提现流程**:
    *   申请 -> **人工核对** (风控) -> 线下转账 -> 后台点击 **“通过/已打款”** (系统扣款)。

### 3.3 用户与地陪 (User & Guide)
*   **资料扩展**:
    *   **LBS**: 采用 **地图 SDK 选点** 方式录入，系统需记录 **经纬度 (Coordinates)**、**城市 (City)** 及 **详细地址 (Address)**。
    *   **期望价格**: 地陪注册时填写。
*   **审核管理**:
    *   审核界面需展示地陪 **全量资料** (头像/相册/简介/常住地)。
    *   审核通过时需设定 **“真实展示价格”**。
    *   **封禁管理**: 管理员可对违规账号进行封禁/解禁，并记录原因。

### 3.4 后台支撑 (Admin Support)
*   **权限管理体系**:
    | 功能模块 | 功能点 | 超级管理员 | 运营客服 |
    | :--- | :--- | :---: | :---: |
    | **地陪管理** | 地陪审核 (含定价) | ✅ | ❌ |
    | | 地陪列表查看 | ✅ | ✅ |
    | **订单管理** | 定制订单创建 | ✅ | ✅ |
    | | 订单列表/详情查看 | ✅ | ✅ |
    | | **订单取消/退款** | ✅ | ❌ |
    | **资金财务** | **提现处理** | ✅ | ❌ |
    | **用户管理** | 用户/地陪封禁 | ✅ | ❌ |
    | **系统配置** | 客服二维码配置 | ✅ | ✅ |

#### 3.4.1 系统配置
*   **客服二维码**: 管理员可在后台上传/更新客服二维码图片，前端动态拉取。

#### 3.4.2 统计需求
*   **基准**: 所有统计均基于 **“订单结算时间”**。
*   **报表**:
    *   **客服业绩**: 统计客服创建且已结算的定制订单数量（日/月/年/总）。
    *   **平台收支**: 统计总收入、总提现金额（日/月/年/总）。

#### 3.4.3 审计日志 (Audit Logs)
*   **定位**: 提供关键操作的业务追溯与可视化查询。
*   **核心场景**:
    1.  **地陪审核**: 记录审核人、时间。
    2.  **资金提现**: 记录确认打款人、金额。
    3.  **用户管理**: 记录封禁/解禁操作人及原因。
    4.  **退款操作**: 记录人工退款详情。
*   **字段**: 操作人、时间、类型、对象、详情。
