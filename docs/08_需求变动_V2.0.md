# 需求变动规格说明书 V2.0 (Revision 3)

**版本**: V2.0 (Rev 3)  
**状态**: Approved (待实施)  
**日期**: 2026-01-27

## 1. 引言 (Introduction)
本次变动旨在重构“定制订单”流程，统一全平台支付逻辑，并完善资金结算、钱包体系及后台管理功能。

---

## 2. 订单业务体系 (Order System)

### 2.1 统一支付与规则
*   **平台内支付**: 所有订单（含普通单、定制单、加时单）均需在平台内完成线上支付，禁止线下转账。
*   **超时自动关闭**: 所有处于 **“待支付”** 状态的订单，若在创建后 **60分钟** 内未完成支付，系统将自动取消/关闭该订单。

### 2.2 定制订单流程 (Custom Order Flow)
1.  **用户扫码**: 已登录用户在定制页面扫描客服微信二维码，添加客服好友。
    *   *前置条件*: 未登录用户访问页面时，系统强制引导注册/登录。
2.  **沟通与确认**: 用户与客服沟通需求，客服确认地陪人选及服务价格。
3.  **后台创单 (Admin Creation)**:
    *   客服在后台录入订单信息（用户账号、地陪账号、服务时间、总价、集合地点）。
    *   **初始状态**: 订单创建后处于 **“待支付”** 状态。
4.  **用户支付**: 用户在前端订单列表查看到该订单，并在线完成支付。
5.  **待服务**: 支付成功后，订单自动流转至 **“待服务”** 状态。

### 2.3 普通订单流程调整 (Standard Order Adjustments)
1.  **下单**: 用户填写下单需求信息。
2.  **待支付**:
    *   界面展示 **客服二维码**，提示 **“请联系客服确认地陪是否可接单”**。
3.  **确认**: 用户联系客服，确认地陪状态及意向。
4.  **支付**: 确认无误后，用户在平台内完成在线支付。
5.  **待服务**: 支付成功后，订单进入 **“待服务”** 状态。

### 2.4 加时服务流程 (Overtime Flow)
*   **发起时机**: 仅限订单处于 **“服务中”** 状态时，由用户在订单详情页发起。
*   **时间计算**:
    *   **未超期**: 若当前时间早于订单结束时间，加时起始时间 = **原订单结束时间** (无缝衔接)。
    *   **已超期**: 若当前时间晚于订单结束时间 (但未结束服务)，加时起始时间 = **当前时间**。
*   **展示细节**:
    *   **列表**: 展示总花费、总时长、开始/结束时间。
    *   **详情**: 展示主订单信息及 **已支付的加时单列表** (1对N)。

### 2.5 异常流程 (Exception Handling)
*   **退款处理**:
    *   MVP 阶段暂不开放前端用户自助退款。
    *   所有退款需求（如地陪爽约、用户取消）均由 **用户联系客服**，客服在后台进行 **人工退款/取消订单** 操作。
    *   退款操作需记录在审计日志中。

---

## 3. 状态流转与展示 (Lifecycle & UI)

### 3.1 服务流转状态机
1.  **待服务**: 支付成功后的初始状态，等待见面。
2.  **服务中**: 地陪到达现场，上传**服务开始照片**，订单流转至此。
3.  **服务结束**: 服务时间结束，地陪点击结束并上传**服务结束照片**。
    *   *业务规则*: 地陪单方面触发结束即可。
4.  **已完成**: 订单结束满 24 小时后，系统自动执行资金结算，订单流转至此。

### 3.2 状态展示映射表

| 系统业务阶段 | 用户端展示 | 地陪端/后台展示 | 说明 |
| :--- | :--- | :--- | :--- |
| 待服务 | 待服务 | 待服务 | 订单就绪，等待见面 |
| 服务中 | 服务中 | 服务中 | 正在服务，可发起加时 |
| 服务结束 | **服务结束** | **服务结束** | 服务已结束，等待结算 |
| 已完成 | **已完成** | **已完成** | 资金已结算入账 |

---

## 4. 资金与结算体系 (Finance)

### 4.1 抽成规则
*   **配置化**: 平台抽成比例可配置，默认为 **25%**。
*   **基数**: 基于用户**实际支付金额**（含定制单支付金额 + 线上加时金额）。
*   **公式**: `地陪收入 = 订单总额 * (1 - 抽成比例)`。

### 4.2 钱包与提现
*   **余额展示**: 在钱包首页展示当前账户余额。
*   **收支明细**:
    *   **粒度**: 以 **“订单总收入/支出”** 为粒度。即一个订单（含所有加时）汇总为一条收入记录。
    *   **内容**: 展示时间、金额、类型，支持点击跳转至关联的 **订单详情页**。
*   **提现流程**:
    1.  用户/地陪发起提现申请。
    2.  管理员后台查看并进行 **线下转账**。
    3.  管理员在后台点击 **“确认打款”**，系统扣除余额。

---

## 5. 管理后台体系 (Admin System)

### 5.1 地陪管理
*   **注册**: 统一注册入口，注册后默认为隐藏状态。
*   **资料维护**:
    *   **常住地**: 采用 **地图 SDK 选点**，记录经纬度、城市及详细地址。
    *   **期望价格**: 地陪注册时填写。
*   **审核与定价**: 管理员审核时，设定 **“真实展示价格”** (前端展示用)。
*   **封禁管理**: 管理员可对违规账号进行封禁/解禁，并记录原因。

### 5.2 系统配置
*   **客服二维码**: 管理员可在后台上传/更新客服二维码图片，前端动态拉取。

### 5.3 统计需求
*   **基准**: 所有统计均基于 **“订单结算时间”**。
*   **报表**:
    *   **客服业绩**: 统计客服创建且已结算的定制订单数量（日/月/年/总）。
    *   **平台收支**: 统计总收入、总提现金额（日/月/年/总）。

### 5.4 审计日志 (Audit Logs)
*   **定位**: 提供关键操作的业务追溯与可视化查询。
*   **核心场景**:
    1.  **地陪审核**: 记录审核人、时间。
    2.  **资金提现**: 记录确认打款人、金额。
    3.  **用户管理**: 记录封禁/解禁操作人及原因。
    4.  **退款操作**: 记录人工退款详情。
*   **字段**: 操作人、时间、类型、对象、详情。

---

## 6. 后续规划 (Roadmap)
1.  **权限管控 (RBAC)**: 精细化的角色权限分配将在后续版本实现，当前所有管理员拥有完整权限。

## 7. 待确认与风险评估 (Open Questions & Risk Assessment)
以下问题需在后续开发或运营过程中重点关注并制定详细规则：

1.  **订单取消与资金策略**: 
    *   不同阶段取消是否扣押用户本金? 怎么退款?
2.  **履约时间风控**: 
    *   由于订单结束没有客户确认环节, 是否拦截这种操作: 1.20的见面的订单, 地陪1.17将状态走完, 18号将钱提走?
3.  **地陪资料合规性**: 
    *   审核流程是否应明确包含对地陪上传内容（图片、简介）的合规性检查（反黄反暴、反私下引流）？
4.  **后台权限边界**: 
    *   后台系统是否需要对 **管理员** 和 **客服** 进行角色权限区分？（例如：是否需要限制客服仅能进行创单操作，而将审核与资金操作限制为管理员权限？）
5.  **普通订单前置确认**: 
    *   在用户支付前，是否需要在系统内增加“客服/地陪确认接单”的强制卡点，以避免用户单方面付款后地陪无法接单的情况？
