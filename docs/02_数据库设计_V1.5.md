# 陪你App - 数据库设计 V1.5

**版本**: 1.5  
**更新日期**: 2026年1月24日  
**用途**: 本文档定义当前系统实际运行的数据库表结构（SSOT），直接对应 `server/db/schema.ts` 代码实现。

---

## 1. 变更记录 (Changelog)

| 版本 | 日期 | 变更内容 |
| :--- | :--- | :--- |
| V1.1 | 2026-01-18 | 初始 MVP 版本 |
| V1.2 | 2026-01-24 | 全量更新以匹配代码库（整合 LBS, Payment 等） |
| V1.5 | 2026-01-24 | 版本号对齐，内容与 V1.2 保持一致（SSOT） |

---

## 2. 设计原则

- **Single Source of Truth**: 本文档反映代码库 `server/db/schema.ts` 的实际定义。
- **Drizzle ORM**: 所有表结构基于 Drizzle ORM 定义，字段命名采用 `camelCase` (代码) 映射到 `snake_case` (数据库)。
- **软删除**: 核心表包含 `deleted_at` 字段。
- **审计**: 包含 `created_at` 和 `updated_at`。

---

## 3. 核心表结构

### 3.1. users (用户表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| phone | VARCHAR(11) | 手机号, 唯一, 非空 |
| password | VARCHAR(255) | 密码 (哈希值), 非空 |
| nickname | VARCHAR(50) | 昵称 |
| avatar_url | VARCHAR(500) | 头像链接 |
| is_guide | BOOLEAN | 是否为地陪 (默认 false) |
| role | ENUM | 角色: 'user', 'admin' (默认 'user') |
| balance | DECIMAL(10, 2) | 余额 (默认 0.00) |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 软删除时间 |

### 3.2. guides (地陪资料表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| user_id | INT | 关联用户ID, 唯一, 外键 -> users.id |
| name | VARCHAR(50) | 真实姓名, 非空 |
| id_number | VARCHAR(18) | 身份证号, 唯一, 非空 |
| city | VARCHAR(50) | 服务城市, 非空 |
| intro | TEXT | 个人简介 |
| hourly_price | DECIMAL(10, 2) | 时薪 |
| tags | JSON | 标签列表 |
| photos | JSON | 照片列表 |
| latitude | DECIMAL(10, 6) | 纬度 (LBS) |
| longitude | DECIMAL(10, 6) | 经度 (LBS) |
| id_verified_at | TIMESTAMP | 实名认证时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 软删除时间 |

### 3.3. orders (订单表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| order_number | VARCHAR(32) | 订单号, 唯一, 非空 |
| user_id | INT | 下单用户ID, 非空, 外键 -> users.id |
| guide_id | INT | 接单地陪ID, 外键 -> guides.id |
| order_type | ENUM | 订单类型: 'normal', 'custom' |
| status | ENUM | 状态: 'pending', 'paid', 'waiting_for_user', 'in_progress', 'completed', 'cancelled' |
| service_start_time | DATETIME | 服务开始时间 |
| service_hours | INT | 服务时长 (小时) |
| service_address | VARCHAR(255) | 服务地点 (文本) |
| service_lat | DECIMAL(10, 6) | 服务地点纬度 |
| service_lng | DECIMAL(10, 6) | 服务地点经度 |
| amount | DECIMAL(10, 2) | 订单金额, 非空 |
| deposit | DECIMAL(10, 2) | 定金 (默认 0.00) |
| requirements | TEXT | 需求描述 |
| content | TEXT | 核心需求内容 (主要用于定制单) |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 软删除时间 |

### 3.4. payments (支付记录表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| order_id | INT | 关联订单ID, 非空, 外键 -> orders.id |
| payment_method | ENUM | 支付方式: 'wechat' (默认 'wechat') |
| transaction_id | VARCHAR(64) | 交易流水号 |
| amount | DECIMAL(10, 2) | 支付金额, 非空 |
| status | ENUM | 状态: 'pending', 'success', 'failed' (默认 'pending') |
| paid_at | TIMESTAMP | 支付完成时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.5. withdrawals (提现记录表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| user_id | INT | 申请用户ID, 非空, 外键 -> users.id |
| amount | DECIMAL(10, 2) | 提现金额, 非空 |
| status | ENUM | 状态: 'pending', 'processing', 'completed', 'failed' (默认 'pending') |
| bank_info | JSON | 银行/收款账号信息 |
| processed_at | TIMESTAMP | 处理时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.6. custom_requirements (私人定制需求表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| order_id | INT | 关联订单ID, 唯一, 非空, 外键 -> orders.id |
| destination | VARCHAR(100) | 目的地, 非空 |
| start_date | DATE | 开始日期, 非空 |
| end_date | DATE | 结束日期, 非空 |
| people_count | INT | 人数, 非空 |
| budget | DECIMAL(10, 2) | 预算 |
| special_requirements | TEXT | 特殊需求 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.7. custom_order_candidates (定制订单候选地陪表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| order_id | INT | 关联订单ID, 非空, 外键 -> orders.id |
| guide_id | INT | 候选地陪ID, 非空, 外键 -> guides.id |
| is_selected | BOOLEAN | 是否被选中 (默认 false) |
| created_at | TIMESTAMP | 创建时间 |

### 3.8. reviews (评价表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| order_id | INT | 关联订单ID, 唯一, 非空, 外键 -> orders.id |
| user_id | INT | 评价用户ID, 非空, 外键 -> users.id |
| guide_id | INT | 被评价地陪ID, 非空, 外键 -> guides.id |
| rating | INT | 评分, 非空 |
| comment | TEXT | 评价内容 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.9. admin_logs (管理员操作日志表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | INT | 主键, 自增 |
| admin_id | INT | 操作管理员ID, 非空, 外键 -> users.id |
| action | VARCHAR(100) | 操作动作, 非空 |
| target_type | VARCHAR(50) | 目标类型 |
| target_id | INT | 目标ID |
| details | JSON | 详情 |
| ip_address | VARCHAR(45) | IP地址 |
| created_at | TIMESTAMP | 创建时间 |
