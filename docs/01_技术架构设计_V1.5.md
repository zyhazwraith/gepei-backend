# 陪你App - 技术架构设计文档 V1.5

**版本**: 1.5  
**更新日期**: 2026年1月24日  
**用途**: 本文档是“陪你App”当前实际运行的技术架构方案（SSOT），反映代码库的真实状态。

---

## 1. 系统架构

### 1.1. 架构概览

本架构采用全栈一体化模式 (Monorepo)，前后端代码统一部署，支持 Web 端访问。

- **后端**: Node.js + Express + TypeScript
- **前端**: React + TypeScript + Tailwind CSS (Vite 构建)
- **数据库**: MySQL 8.0+ (使用 Drizzle ORM)
- **部署**: 单机 VPS 部署

```mermaid
graph TD
    subgraph "客户端"
        A[用户浏览器] -->|HTTPS| B{Nginx / Node.js}
    end

    subgraph "服务器 (Single VPS)"
        B -->|/api/*| C[Express 后端服务]
        B -->|/* 静态资源| D[React 前端构建产物 (client/dist)]
        C <--> E[MySQL 数据库]
        C -->|本地存储| F[文件上传目录 (uploads/)]
    end
```

### 1.2. 项目结构 (Monorepo)

```
gepei-app/
├── server/          # Express 后端代码
│   ├── controllers/ # 业务逻辑
│   ├── routes/      # 路由定义
│   ├── models/      # Drizzle ORM 模型
│   ├── middleware/  # 中间件 (Auth, ErrorHandler)
│   └── ...
├── client/          # React 前端代码 (Vite)
├── shared/          # 前后端共享类型 (Types)
├── docs/            # 项目文档 (SSOT)
└── package.json     # 统一依赖管理
```

---

## 2. 技术栈选型

| 模块 | 技术选型 | 说明 |
| :--- | :--- | :--- |
| **后端框架** | **Express + TypeScript** | 轻量级，生态成熟，配合 `tsx` 运行。 |
| **ORM** | **Drizzle ORM** | 类型安全，高性能，支持 MySQL。 |
| **数据库** | **MySQL 8.0+** | 核心数据存储。LBS 功能通过 `DECIMAL` 类型实现经纬度存储。 |
| **认证** | **JWT (jsonwebtoken)** | 无状态认证，Token 包含用户 ID 和角色。 |
| **密码安全** | **bcryptjs** | 用户密码加盐哈希存储。 |
| **文件上传** | **Multer** | 处理 `multipart/form-data`，文件存储在本地 `uploads/` 目录。 |
| **前端框架** | **React 19 + Vite** | 现代前端开发栈。 |
| **UI 组件** | **Shadcn/ui + Tailwind** | 高效构建美观界面。 |

---

## 3. 关键功能实现方案

### 3.1. LBS (基于位置的服务)
- **存储**: 使用 `DECIMAL(10, 6)` 存储经纬度（精度约 0.1 米）。
- **查询**: 后端通过 Haversine 公式或简单的矩形范围查询计算距离（MVP 阶段方案）。
- **接口**: API 支持 `lat`, `lng` 参数，返回计算后的 `distance` 字段。

### 3.2. 认证与权限
- **Token**: 登录成功后返回 JWT Token。
- **中间件**: 
    - `authenticate`: 验证 Token 有效性，注入 `req.user`。
    - `authorize`: 验证用户角色 (`admin` / `user`)。

### 3.3. 订单流程
- **状态机**: 订单状态流转严谨 (`pending` -> `paid` -> `waiting_for_user` -> `in_progress` -> `completed`)。
- **定制订单**: 支持管理员指派候选人 (`assign`) -> 用户选择 (`select-guide`) 的流程。

### 3.4. 文件存储
- **策略**: MVP 阶段直接存储在服务器本地文件系统。
- **访问**: 通过 Express 静态资源服务 (`/uploads`) 对外提供访问。
- **命名**: 使用 UUID + 时间戳生成唯一文件名，防止冲突。

---

## 4. 未来规划 (Roadmap)

- **微信支付**: 集成微信支付 API (目前仅有数据库表结构支持)。
- **消息推送**: 实现 WebSocket 或 SSE 以支持实时通知。
- **对象存储**: 将文件存储迁移至 AWS S3 或阿里云 OSS。
- **CI/CD**: 建立自动化部署流程。
