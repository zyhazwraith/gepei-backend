# 陪你App - 数据库设计 V2.0 (FINAL)

**版本**: 2.2  
**日期**: 2026-01-28  
**状态**: Approved  
**设计原则**: 文档驱动开发 (Document-Driven Development)。本文件作为 V2.0 开发的**核心 Prompt 上下文**，指导 `schema.ts` 的生成。

---

## 1. 变更摘要 (Changelog)

基于 V1.5 版本，V2.0 进行了以下核心架构升级：

1.  **LBS 位置服务**: `users` 和 `guides` 表引入经纬度坐标，支持基于位置的推荐。
2.  **双重价格体系**: `guides` 表区分 `expected_price` (地陪填) 和 `real_price` (管理员审)，**订单计费一律以 `real_price` 为准**。
3.  **定制单重构**: 废弃旧的“竞标模式”，改为“客服建单模式”。`orders` 表新增 `type` 和 `price_per_hour` (单价快照)，支持定制单的灵活计费。
4.  **资金闭环**: 新增 `wallet_logs` 统一管理资金流转（收入/提现/退款），金额全额改用 **INT (分)**。
5.  **资源管理**: 新增 `attachments` 表（原 files）统一管理图片/文件，业务表只存 ID，解耦存储与业务，利于 OBS 迁移。
6.  **架构优化**: `guides` 表移除冗余自增 ID，改用 `user_id` 作为主键；角色扩充客服 (`cs`)。

---

## 2. 核心表结构 (Core Schema)

### 2.1 users (用户表)
*基础用户信息，包含客户端与地陪端的通用属性。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 用户ID | |
| phone | VARCHAR(11) | Unique | 手机号 | |
| password | VARCHAR(255) | | 密码哈希 | |
| nickname | VARCHAR(50) | | 昵称 | |
| is_guide | BOOLEAN | Default false | 是否认证为地陪 | |
| role | ENUM | 'user', 'admin', **'cs'** | 角色 (cs=客服) | **[修改]** 增加 cs |
| **balance** | INT | Default 0 | 账户余额 (**单位: 分**) | **[修改]** 改用 INT |
| **status** | ENUM | 'active', 'banned' | 账户状态 | **[新增]** |
| **ban_reason** | VARCHAR(255) | | 封禁原因 | **[新增]** |
| created_at | TIMESTAMP | | | |

### 2.2 guides (地陪资料表)
*地陪专属业务属性，与 users 表 1:1 关联。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| **user_id** | INT | PK, FK(users) | 关联用户ID (**兼主键**) | **[修改]** 移除自增 ID |
| name | VARCHAR(50) | | 真实姓名 | |
| **avatar_id** | INT | FK(attachments) | 地陪头像ID | **[新增]** |
| id_number | VARCHAR(18) | Unique | 身份证号 | |
| intro | TEXT | | 个人简介 | |
| **expected_price**| INT | | **期望时薪** (单位: 分) | **[新增]** |
| **real_price** | INT | | **真实展示时薪** (单位: 分) | **[重定义]** 原 hourly_price |
| **photo_ids** | JSON | | 相册附件ID列表 (e.g. `[1,2]`) | **[修改]** 存 ID 数组 |
| **latitude** | DECIMAL(10,6) | | 纬度 | **[新增]** |
| **longitude** | DECIMAL(10,6) | | 经度 | **[新增]** |
| **city** | VARCHAR(50) | | 城市 | **[新增]** |
| **address** | VARCHAR(255) | | 详细地址 | **[新增]** |
| id_verified_at | TIMESTAMP | | 实名认证时间 | |

### 2.3 orders (订单表)
*核心交易单据。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 订单ID | |
| order_number | VARCHAR(32) | Unique | 订单号 | |
| user_id | INT | FK(users) | 下单用户 | |
| **guide_id** | INT | FK(users) | 接单地陪 (关联 guides.user_id) | **[修改]** 外键指向 users (V2: 必填) |
| **creator_id** | INT | FK(users) | 创建人 (普通单=用户, 定制单=客服) | **[新增]** |
| **type** | ENUM | 'standard', 'custom' | 订单类型 | **[新增]** |
| **status** | ENUM | pending, paid, waiting_service, in_service, **service_ended**, completed, cancelled, **refunded** | 订单状态 | **[修改]** |
| **price_per_hour** | INT | | **单价快照** (单位: 分) | **[新增]** |
| duration | INT | | 预约时长 (小时) | |
| **total_duration** | INT | Default 0 | **实际总时长** (预约+加时) | **[新增]** |
| **amount** | INT | | **订单原价** (Base Amount, 不含加时) | **[修改]** 语义收窄 |
| **total_amount** | INT | Default 0 | **总流水** (Base + Overtime) | **[新增]** |
| **guide_income** | INT | Default 0 | **地陪收入** (持久化字段) | **[新增]** |
| **refund_amount** | INT | Default 0 | 退款金额 (单位: 分) | **[新增]** |
| **content** | TEXT | | **核心服务内容** (纯文本描述) | **[修改]** |
| **requirements** | TEXT | | **备注/特殊要求** | **[拆分]** |
| service_start_time | TIMESTAMP | | 预约服务时间 | |
| **service_end_time** | TIMESTAMP | | **预计服务结束时间** (自动计算: start_time + duration) | **[新增]** 用于档期管理 |
| **paid_at** | TIMESTAMP | | 支付时间 | **[新增]** |
| **actual_end_time** | TIMESTAMP | | **服务实际结束时间** | **[重定义]** 原 completed_at |
| created_at | TIMESTAMP | | | |

### 2.4 overtime_records (加时记录表)
*独立加时服务单，关联主订单。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 加时ID | **[新增表]** |
| order_id | INT | FK(orders) | 关联主订单 | |
| **duration** | INT | | **计费时长** (小时) | |
| **fee** | INT | | 加时费用 (单位: 分) | **[修改]** 改用 INT |
| status | ENUM | 'pending', 'paid' | 支付状态 | |
| **start_time** | TIMESTAMP | | 加时**物理**开始时间 | |
| **end_time** | TIMESTAMP | | 加时**物理**结束时间 | |
| created_at | TIMESTAMP | | | |

### 2.5 wallet_logs (资金流水表)
*统一记录用户余额的所有变动（SSOT of Money）。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 流水ID | **[新增表]** |
| user_id | INT | FK(users) | 用户ID | |
| type | ENUM | 'income', 'withdraw_freeze', 'withdraw_unfreeze', 'withdraw_success', 'refund' | 变动类型 | |
| **amount** | INT | | 变动金额 (单位: 分, +/-) | **[修改]** 改用 INT |
| related_type | VARCHAR(50) | | 关联对象类型 (order, withdrawal) | |
| related_id | INT | | 关联对象ID | |
| created_at | TIMESTAMP | | | |

**Type 枚举说明**:
*   `income`: 订单结算收入 (Order Completed) -> 余额增加
*   `withdraw_freeze`: 提现申请冻结 (Withdrawal Created) -> 余额减少
*   `withdraw_unfreeze`: 提现驳回解冻 (Withdrawal Rejected) -> 余额增加
*   `withdraw_success`: 提现打款成功 (Withdrawal Completed) -> 余额不变 (已在 freeze 扣除，此处仅标记)
*   `refund`: 退款返还 (Refund) -> 用户余额增加

### 2.6 payments (支付记录表)
*仅记录外部支付网关（微信支付）的入账流水。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 支付ID | |
| **amount** | INT | | 支付金额 (单位: 分) | **[修改]** 改用 INT |
| transaction_id | VARCHAR(64) | | 微信交易号 | |
| status | ENUM | 'pending', 'success', 'failed' | 状态 | |
| related_type | ENUM | 'order', 'overtime' | 支付对象类型 | **[新增]** |
| related_id | INT | | 支付对象ID (OrderID / OvertimeRecordID) | **[修改]** 泛化支持加时单 |

### 2.7 withdrawals (提现申请表)
| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 提现ID | |
| user_id | INT | FK(users) | 申请人 | |
| **amount** | INT | | 申请金额 (单位: 分) | **[修改]** 改用 INT |
| status | ENUM | 'pending', 'completed', 'rejected' | 状态 | **[修改]** 简化为三态 |
| **user_note** | VARCHAR(255) | | **收款备注** (微信号/银行卡) | **[新增]** |
| **admin_note** | VARCHAR(255) | | **审核备注** (驳回理由/打款凭证) | **[新增]** |
| **audit_log_id**| INT | FK(audit_logs) | 关联的审核记录ID | **[新增]** |

### 2.8 refund_records (退款记录表)
*结构化的退款详情，便于财务对账。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 退款ID | **[新增表]** |
| order_id | INT | FK(orders) | 关联订单 | |
| **amount** | INT | | 实际退款金额 (单位: 分) | **[修改]** 改用 INT |
| **out_refund_no** | VARCHAR(64) | Unique | **商户退款单号** (系统生成) | **[V2.1 新增]** |
| **refund_transaction_id** | VARCHAR(64) | | **渠道退款单号** (微信返回) | **[V2.1 新增]** |
| **status** | ENUM | 'pending', 'success', 'failed' | 退款状态 | **[V2.1 新增]** |
| reason | VARCHAR(255) | | 退款原因/备注 | |
| operator_id | INT | FK(users) | 操作人 (用户或客服) | |
| created_at | TIMESTAMP | | | |

### 2.9 audit_logs (审计日志表)
*记录关键业务操作。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 日志ID | **[重构]** 原 admin_logs |
| operator_id | INT | FK(users) | 操作人ID | |
| action | VARCHAR(50) | | 动作 (guide_audit, withdraw_audit, refund, ban_user) | |
| target_type | VARCHAR(50) | | 目标类型 | |
| target_id | INT | | 目标ID | |
| details | JSON | | 操作详情快照 | |
| ip_address | VARCHAR(45) | | IP地址 | |
| created_at | TIMESTAMP | | 操作时间 | |

### 2.10 attachments (附件/文件表)
*统一资源索引，解耦存储与业务。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 附件ID | **[新增表]** 改名自 files |
| uploader_id | INT | FK(users) | 上传者 | |
| **key** | VARCHAR(255) | Unique | 唯一标识/相对路径 | **[新增]** 支持覆盖逻辑 |
| url | VARCHAR(500) | | 访问链接 | |
| storage_type | ENUM | 'local', 'oss' | 存储类型 | |
| file_type | VARCHAR(50) | | MIME类型 | |
| usage_type | VARCHAR(50) | | 用途 | |

### 2.11 check_in_records (打卡记录表)
*地陪服务打卡存证。*

| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| id | INT | PK, Auto | 打卡ID | **[新增表]** |
| order_id | INT | FK(orders) | 关联订单 | |
| type | ENUM | 'start', 'end' | 打卡类型 | |
| time | TIMESTAMP | | 打卡时间 | |
| **latitude** | DECIMAL(10,6) | | 纬度 | **[新增]** |
| **longitude** | DECIMAL(10,6) | | 经度 | **[新增]** |
| **attachment_id** | INT | FK(attachments) | 现场照片 | **[修改]** 存 Attachment ID |

### 2.12 system_configs (系统配置表)
| 字段名 | 类型 | 属性 | 说明 | V2 变更 |
| :--- | :--- | :--- | :--- | :--- |
| key | VARCHAR(50) | PK | 配置键 (e.g., 'cs_qrcode_url') | **[新增表]** |
| value | TEXT | | 配置值 | |
| description | VARCHAR(100) | | 描述 | |

---

## 3. 废弃实体 (Deprecated)
*   **custom_requirements**: 字段已合并至 `orders.content`。
*   **custom_order_candidates**: 业务流程变更为客服直接指派，无需候选人列表。
